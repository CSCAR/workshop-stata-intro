<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Introduction to Stata - 4&nbsp; Data Manipulation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./05-programming.html" rel="next">
<link href="./03-data-management.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./04-data-manipulation.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Data Manipulation</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Introduction to Stata</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-the-basics-of-stata.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">The Basics of Stata</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-working-with-data-sets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Working with Data Sets</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-data-management.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Data Management</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-data-manipulation.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Data Manipulation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-programming.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Programming &amp; Advanced Features</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./appendix.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Appendix</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#restricting-commands-to-subsets" id="toc-restricting-commands-to-subsets" class="nav-link active" data-scroll-target="#restricting-commands-to-subsets"><span class="header-section-number">4.1</span> Restricting commands to subsets</a></li>
  <li><a href="#generating-new-variables" id="toc-generating-new-variables" class="nav-link" data-scroll-target="#generating-new-variables"><span class="header-section-number">4.2</span> Generating new variables</a>
  <ul class="collapse">
  <li><a href="#creating-dummies" id="toc-creating-dummies" class="nav-link" data-scroll-target="#creating-dummies"><span class="header-section-number">4.2.1</span> Creating dummies</a></li>
  <li><a href="#system-variables" id="toc-system-variables" class="nav-link" data-scroll-target="#system-variables"><span class="header-section-number">4.2.2</span> System Variables</a></li>
  <li><a href="#extensions-to-generate" id="toc-extensions-to-generate" class="nav-link" data-scroll-target="#extensions-to-generate"><span class="header-section-number">4.2.3</span> Extensions to generate</a></li>
  </ul></li>
  <li><a href="#replacing-existing-variables" id="toc-replacing-existing-variables" class="nav-link" data-scroll-target="#replacing-existing-variables"><span class="header-section-number">4.3</span> Replacing existing variables</a>
  <ul class="collapse">
  <li><a href="#conditional-variable-generation" id="toc-conditional-variable-generation" class="nav-link" data-scroll-target="#conditional-variable-generation"><span class="header-section-number">4.3.1</span> Conditional variable generation</a></li>
  </ul></li>
  <li><a href="#more-complicated-replaces" id="toc-more-complicated-replaces" class="nav-link" data-scroll-target="#more-complicated-replaces"><span class="header-section-number">4.4</span> More complicated replaces</a></li>
  <li><a href="#subsetting" id="toc-subsetting" class="nav-link" data-scroll-target="#subsetting"><span class="header-section-number">4.5</span> Subsetting</a>
  <ul class="collapse">
  <li><a href="#repeat-commands-on-subsets" id="toc-repeat-commands-on-subsets" class="nav-link" data-scroll-target="#repeat-commands-on-subsets"><span class="header-section-number">4.5.1</span> Repeat commands on subsets</a></li>
  <li><a href="#discarding-data" id="toc-discarding-data" class="nav-link" data-scroll-target="#discarding-data"><span class="header-section-number">4.5.2</span> Discarding data</a></li>
  </ul></li>
  <li><a href="#dealing-with-duplicates" id="toc-dealing-with-duplicates" class="nav-link" data-scroll-target="#dealing-with-duplicates"><span class="header-section-number">4.6</span> Dealing with duplicates</a></li>
  <li><a href="#sorting" id="toc-sorting" class="nav-link" data-scroll-target="#sorting"><span class="header-section-number">4.7</span> Sorting</a></li>
  <li><a href="#working-with-strings-and-categorical-variables" id="toc-working-with-strings-and-categorical-variables" class="nav-link" data-scroll-target="#working-with-strings-and-categorical-variables"><span class="header-section-number">4.8</span> Working with strings and categorical variables</a>
  <ul class="collapse">
  <li><a href="#converting-between-string-and-numeric" id="toc-converting-between-string-and-numeric" class="nav-link" data-scroll-target="#converting-between-string-and-numeric"><span class="header-section-number">4.8.1</span> Converting between string and numeric</a></li>
  <li><a href="#converting-strings-into-labeled-numbers" id="toc-converting-strings-into-labeled-numbers" class="nav-link" data-scroll-target="#converting-strings-into-labeled-numbers"><span class="header-section-number">4.8.2</span> Converting strings into labeled numbers</a></li>
  <li><a href="#string-manipulation" id="toc-string-manipulation" class="nav-link" data-scroll-target="#string-manipulation"><span class="header-section-number">4.8.3</span> String manipulation</a></li>
  </ul></li>
  <li><a href="#exercise-5" id="toc-exercise-5" class="nav-link" data-scroll-target="#exercise-5"><span class="header-section-number">4.9</span> Exercise 5</a></li>
  <li><a href="#merging-files" id="toc-merging-files" class="nav-link" data-scroll-target="#merging-files"><span class="header-section-number">4.10</span> Merging Files</a>
  <ul class="collapse">
  <li><a href="#appending-files" id="toc-appending-files" class="nav-link" data-scroll-target="#appending-files"><span class="header-section-number">4.10.1</span> Appending Files</a></li>
  <li><a href="#match-merging-data" id="toc-match-merging-data" class="nav-link" data-scroll-target="#match-merging-data"><span class="header-section-number">4.10.2</span> Match-merging Data</a></li>
  </ul></li>
  <li><a href="#reshaping-files" id="toc-reshaping-files" class="nav-link" data-scroll-target="#reshaping-files"><span class="header-section-number">4.11</span> Reshaping Files</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Data Manipulation</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Let’s reload the “auto” data to discard any changes made in previous sections and to start fresh.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">sysuse</span> auto, <span class="kw">clear</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>(1978 automobile <span class="kw">data</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="restricting-commands-to-subsets" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="restricting-commands-to-subsets"><span class="header-section-number">4.1</span> Restricting commands to subsets</h2>
<p>We’ll discuss operating on subsets of the data in far more detail a bit <a href="04-data-manipulation.html#subsetting">later</a>, but first we’ll discuss how to modify the <a href="01-the-basics-of-stata.html#basic-command-syntax">basic command syntax</a> to run a command only on some rows of data.</p>
<p>Recall the basic command syntax,</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>command &lt;<span class="kw">variable</span>(<span class="fu">s</span>)&gt;, &lt;options&gt;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>By default, this will use all rows of the data it can. However, we can restrict this.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>command &lt;<span class="kw">variable</span>(<span class="fu">s</span>)&gt; <span class="kw">in</span> &lt;number <span class="ot">list</span>&gt;, &lt;options&gt;</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>command &lt;<span class="kw">variable</span>(<span class="fu">s</span>)&gt; <span class="kw">if</span> &lt;condition&gt;, &lt;options&gt;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Both are optional (obviously), but you can include them if desired.</p>
<p>Using <code>in</code>, we pass a number list which consists of a lower bound, a <code>/</code>, and an upper bound. For example, if we wanted to summarize the first 10 rows for a variable, we could run:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">summarize</span> <span class="kw">weight</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    Variable |        Obs        Mean    Std. <span class="kw">dev</span>.       Min        Max</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>-------------+---------------------------------------------------------</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">weight</span> |         74    3019.459    777.1936       1760       4840</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>. <span class="kw">summarize</span> <span class="kw">weight</span> <span class="kw">in</span> 1/10</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    Variable |        Obs        Mean    Std. <span class="kw">dev</span>.       Min        Max</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>-------------+---------------------------------------------------------</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">weight</span> |         10        3271    558.3796       2230       4080</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As you can see, the second call to <code>summarize</code> thinks there are only 10 rows of data.</p>
<p>The <code>if</code> requires defining a conditional statement. Consider the following statements</p>
<p><span class="math display">\[
  4 \gt 2
\]</span> <span class="math display">\[
  1 \gt 2
\]</span></p>
<p>Remembering back to middle school math classes that <span class="math inline">\(\gt\)</span> means “greater than”, clearly the first statement is true and the second statement is false. We can assign values of true and false to any such conditional statements, which use the following set of conditional operators:</p>
<table class="table">
<colgroup>
<col style="width: 8%">
<col style="width: 33%">
<col style="width: 28%">
<col style="width: 29%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Sign</th>
<th style="text-align: left;">Definition</th>
<th style="text-align: left;">True example</th>
<th style="text-align: center;">False example</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(==\)</span></td>
<td style="text-align: left;">equality</td>
<td style="text-align: left;"><span class="math inline">\(3 == 3\)</span></td>
<td style="text-align: center;"><span class="math inline">\(3 == 2\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(!=\)</span></td>
<td style="text-align: left;">not equal</td>
<td style="text-align: left;"><span class="math inline">\(3 != 4\)</span></td>
<td style="text-align: center;"><span class="math inline">\(3 != 3\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(\gt\)</span></td>
<td style="text-align: left;">greater than</td>
<td style="text-align: left;"><span class="math inline">\(4 \gt 2\)</span></td>
<td style="text-align: center;"><span class="math inline">\(1 \gt 2\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(\lt\)</span></td>
<td style="text-align: left;">less than</td>
<td style="text-align: left;"><span class="math inline">\(1 \lt 2\)</span></td>
<td style="text-align: center;"><span class="math inline">\(4 \lt 2\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;"><span class="math inline">\(\gt=\)</span></td>
<td style="text-align: left;">greater than or equal to</td>
<td style="text-align: left;"><span class="math inline">\(4 \gt= 4\)</span></td>
<td style="text-align: center;"><span class="math inline">\(1 \gt= 2\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(\lt=\)</span></td>
<td style="text-align: left;">less than or equal to</td>
<td style="text-align: left;"><span class="math inline">\(1 \lt= 1\)</span></td>
<td style="text-align: center;"><span class="math inline">\(4 \lt= 2\)</span></td>
</tr>
<tr class="odd">
<td style="text-align: center;">&amp;</td>
<td style="text-align: left;">and (both statements are true)</td>
<td style="text-align: left;"><span class="math inline">\((4 \gt 2)\)</span> &amp; <span class="math inline">\((3 == 3)\)</span></td>
<td style="text-align: center;"><span class="math inline">\((4 \gt 2)\)</span> &amp; <span class="math inline">\((1 \gt 2)\)</span></td>
</tr>
<tr class="even">
<td style="text-align: center;"><span class="math inline">\(\|\)</span></td>
<td style="text-align: left;">or (either statement is true)</td>
<td style="text-align: left;"><span class="math inline">\((3 == 2) \| (1 \lt= 2)\)</span></td>
<td style="text-align: center;"><span class="math inline">\((4 \lt 2) \| (1 \gt 2)\)</span></td>
</tr>
</tbody>
</table>
<p>So we could summarize a variable only when some other variables have some values.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">summarize</span> <span class="kw">weight</span> <span class="kw">if</span> foreign == 1</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    Variable |        Obs        Mean    Std. <span class="kw">dev</span>.       Min        Max</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>-------------+---------------------------------------------------------</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">weight</span> |         22    2315.909    433.0035       1760       3420</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>. <span class="kw">summarize</span> <span class="kw">weight</span> <span class="kw">if</span> foreign == 1 | (mpg &gt; 20 &amp; headroom &lt; 10)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    Variable |        Obs        Mean    Std. <span class="kw">dev</span>.       Min        Max</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>-------------+---------------------------------------------------------</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">weight</span> |         41    2505.122     585.291       1760       4290</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note in the second example we used parentheses to evaluate a more complex expression; we follow order of operations (remember PEMBAS?) and evaluate the inner-most parantheses first. So first <code>mpg &gt; 20 &amp; headroom &lt; 10</code> gets evaluated and returns <code>TRUE</code> or <code>FALSE</code>; then following that, we evaluate either <code>foreign == 1 | TRUE</code> or <code>foreign == 1 | FALSE</code> depending on what the first result was.</p>
<p>We saw the usage of this earlier when discussing <a href="02-working-with-data-sets.html#loading-subsets-of-the-data">loading subsets of the data</a>.</p>
</section>
<section id="generating-new-variables" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="generating-new-variables"><span class="header-section-number">4.2</span> Generating new variables</h2>
<p>The <code>generate</code> command can be used to create new variables which are functions of existing variables. For example, if we look at the variable label for <code>weight</code>, we see that it is measured in pounds.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">describe</span> <span class="kw">weight</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>Variable      Storage   Display    Value</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="bn">name</span>         <span class="dv">type</span>    <span class="kw">format</span>    <span class="kw">label</span>      Variable <span class="kw">label</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>-------------------------------------------------------------------------------</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="kw">weight</span>          <span class="kw">int</span>     %8.0gc                Weight (lbs.)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s create a second weight variable measured in tons. The syntax for <code>generate</code> is straightforward,</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">generate</span> &lt;<span class="kw">new</span> varname&gt; = &lt;<span class="kw">function</span> <span class="kw">of</span> old variables&gt;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">generate</span> weight2 = <span class="kw">weight</span>/2000</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>list</code> command can be used to output some data, let’s use it here to output the first 5 rows’ <code>weight</code> and <code>weight2</code> variables:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>. <span class="ot">list</span> <span class="kw">weight</span>* <span class="kw">in</span> 1/5</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>     +------------------+</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>     | <span class="kw">weight</span>   weight2 |</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>     |------------------|</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  1. |  2,930     1.465 |</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  2. |  3,350     1.675 |</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  3. |  2,640      1.32 |</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  4. |  3,250     1.625 |</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  5. |  4,080      2.04 |</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>     +------------------+</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(Note: I use <code>list</code> here because I need the variables outputted to create the document. When using Stata interactively, it’d probably be nicer to use <code>browse</code> or <code>edit</code> in the exact same fashion, e.g.&nbsp;<code>browse weights* in 1/5</code>. These enter the Data Browser (<code>browse</code>) or Data Browser (Edit Mode) (<code>edit</code>) showing the same subset of rows/columns as requested.)</p>
<p>If you check the arithmetic, you’ll see that we’ve got the right answer. We should probably add a variable label to our new <code>weight</code></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">label</span> <span class="kw">variable</span> weight2 <span class="st">"Weight (tons)"</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>. <span class="kw">describe</span> <span class="kw">weight</span>*</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>Variable      Storage   Display    Value</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="bn">name</span>         <span class="dv">type</span>    <span class="kw">format</span>    <span class="kw">label</span>      Variable <span class="kw">label</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>-------------------------------------------------------------------------------</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="kw">weight</span>          <span class="kw">int</span>     %8.0gc                Weight (lbs.)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>weight2         <span class="kw">float</span>   %9.0g                 Weight (tons)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In addition to direct arithmetic equations, we can use a number of functions to perform calculations. For example, a common transformation is to take the log of any monetary variable, in our case <code>price</code>. This is done because typical monetary variables, such as price or salary, tend to be very right-skewed - most people make $30k-50k, and a few people make 6 or 7 digit incomes.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">generate</span> logprice = <span class="fu">log</span>(price)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>. <span class="kw">label</span> <span class="kw">variable</span> logprice <span class="st">"Log price"</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>. <span class="ot">list</span> *price <span class="kw">in</span> 1/5</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>     +------------------+</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>     | price   logprice |</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>     |------------------|</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  1. | 4,099   8.318499 |</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  2. | 4,749    8.46569 |</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  3. | 3,799   8.242494 |</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  4. | 4,816   8.479699 |</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  5. | 7,827   8.965335 |</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>     +------------------+</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In that command, <code>log</code> is the function name, and it is immediately followed by parentheses which enclose the variable to operate on. Read the parentheses as “of”, so that <code>log(price)</code> is read as “log of price”.</p>
<p>There are a lot of functions that can be used. We list some commonly used mathematical functions below for your convenience:</p>
<ul>
<li><code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>: Standard arithmetic</li>
<li><code>abs( )</code>: returns the absolute value</li>
<li><code>exp( )</code>: returns the exponential function of <span class="math inline">\(e^x\)</span></li>
<li><code>log( )</code> or <code>ln( )</code>: returns the natural logarithm of the argument<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></li>
<li><code>round( )</code>, <code>ceil( )</code>, <code>floor( )</code>: returns the rounded value (rounded to nearest integer, rounded up, and rounded down)</li>
<li><code>sqrt( )</code>: returns the square root</li>
</ul>
<p>You can see a full accounting of all functions you can use in this setting in</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">help</span> functions</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="creating-dummies" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="creating-dummies"><span class="header-section-number">4.2.1</span> Creating dummies</h3>
<p>Dummy variables (also known as indicator variables or binary variables) are variables which take on two values, 0 and 1<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>. These are typically used in a setting where the 0 represents an absence of something (or an answer of “no”) and 1 represents the presence (or an answer of “yes”). When naming dummy variables, you should keep this in mind to make understanding the variable easier, as well as extracting interpretations regarding the variable in a model.</p>
<p>For example, “highschool” is a poor dummy variable - what does 0 highschool or 1 highschool represent? Obviously we could (and should) use <a href="03-data-management.html#labeling-values">value labels</a> to associate 0 and 1 with informative labels, but it is more straightforward to use a variable name such as “highschool_graduate” or “graduateded_highschool) - a 0 represents”no” to the question of “graduated high school?”, hence a non-high school graduate; and a 1 represents a “yes”, hence a high school graduate.</p>
<p>If you are collecting data, consider collecting data as dummies where appropriate - if the question has a binary response, encode it as a dummy instead of strings. If a question has categorical responses, consider encoding them as a series of dummy variables instead (e.g.&nbsp;“Are you from MI?”, “Are you from OH?” etc). These changes will (usually) need to be made later anyways.</p>
<p>Now here’s the trick: In Stata<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>, <a href="04-data-manipulation.html#restricting-commands-to-subsets">conditional statements</a> return 1 (True) and 0 (False). So we can use them in <code>generate</code> statements to create binary variables easily.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">generate</span> price4k = price &gt; 4000</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>. <span class="ot">list</span> price* <span class="kw">in</span> 1/5</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>     +-----------------+</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>     | price   price4k |</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>     |-----------------|</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  1. | 4,099         1 |</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  2. | 4,749         1 |</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  3. | 3,799         0 |</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  4. | 4,816         1 |</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  5. | 7,827         1 |</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>     +-----------------+</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that this is NOT the same thing as using <a href="04-data-manipulation.html#restricting-commands-to-subsets"><code>if</code></a>. E.g., we see the following error:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">generate</span> price4k2 = <span class="kw">if</span> price &gt; 4000</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> <span class="kw">not</span> found</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">r</span>(111);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now, <code>price4k</code> takes on values 1 and 0 depending on whether the conditional statement was true.</p>
<p>For a slightly more complicated example, lets create a dummy variable representing cheap cars. There are two possible definitions of cheap cars - cars which have a low cost, or cars which have low maintenance costs (high mileage and low repairs).</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">generate</span> cheap = price &lt; 3500 | (rep78 &lt;= 2 &amp; mpg &gt; 20)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>. <span class="ot">list</span> make price rep78 mpg <span class="kw">if</span> cheap == 1</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>     +-----------------------------------------+</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>     | make                price   rep78   mpg |</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>     |-----------------------------------------|</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a> 14. | Chev. Chevette      3,299       3    29 |</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a> 17. | Chev. Monte Carlo   5,104       2    22 |</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a> 18. | Chev. Monza         3,667       2    24 |</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a> 34. | Merc. Zephyr        3,291       3    20 |</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a> 40. | Olds Starfire       4,195       1    24 |</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>     |-----------------------------------------|</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a> 52. | Pont. Sunbird       4,172       2    24 |</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>     +-----------------------------------------+</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>list</code> commands conditions on <code>cheap == 1</code> because again, the conditional statement will return 1 for true and 0 for false. We see 6 cheap cars; the Chevette and Zephyr are cheap because of their cost, whereas the other four cars are cheap because of the maintenance costs.</p>
</section>
<section id="system-variables" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="system-variables"><span class="header-section-number">4.2.2</span> System Variables</h3>
<p>In Stata, under the <a href="01-the-basics-of-stata.html#one-data">One Data</a> principal, any information in the data<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> must be in a variable. This includes the System Variables of <code>_n</code> and <code>_N</code>. You can imagine that every data st you ever open has two additional columns of data, one for <code>_n</code> and one for <code>_N</code>.</p>
<p><code>_n</code> represents the row number, currently. “Currently” means if the data is re-sorted, <code>_n</code> can change.</p>
<p><code>_N</code> represents the total number of rows in the data, hence this is the same for every row. Again, if the data changes (e.g.&nbsp;you <a href="04-data-manipulation.html#discarding-data">drop</a> some data) then <code>_N</code> may be updated.</p>
<p>While you cannot access these System Variables normally (e.g.&nbsp;they don’t appear in the Data Browser), you can use them in generating variables or conditional statements. For example, we’ve seen that <code>list</code> can use <code>in</code> to restrict the rows it outputs, and we’ve seen that it can use <code>if</code> to choose conditionally. We can combine these:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>. <span class="ot">list</span> make <span class="kw">in</span> 1/2</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>     +-------------+</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>     | make        |</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>     |-------------|</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  1. | AMC Concord |</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  2. | AMC Pacer   |</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>     +-------------+</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>. <span class="ot">list</span> make <span class="kw">if</span> <span class="dt">_n</span> &lt;= 2</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>     +-------------+</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>     | make        |</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>     |-------------|</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  1. | AMC Concord |</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  2. | AMC Pacer   |</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>     +-------------+</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A more useful example is to save the initial row numbering in your data. When we discuss <a href="04-data-manipulation.html#sorting">sorting</a> later, it may be useful to be able to return to the original ordering. Since <code>_n</code> changes when the data is re-sorted, if we save the initial row numbers to a permanent variable, we can always re-sort by it later. <code>_N</code> is slightly less useful but can be used similarly.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">generate</span> <span class="ot">row</span> = <span class="dt">_n</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>. <span class="kw">generate</span> totalobs = _N</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>. <span class="ot">list</span> <span class="ot">row</span> totalobs <span class="kw">in</span> 1/5</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>     +----------------+</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>     | <span class="ot">row</span>   totalobs |</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>     |----------------|</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  1. |   1         74 |</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  2. |   2         74 |</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  3. |   3         74 |</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  4. |   4         74 |</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  5. |   5         74 |</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>     +----------------+</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="extensions-to-generate" class="level3" data-number="4.2.3">
<h3 data-number="4.2.3" class="anchored" data-anchor-id="extensions-to-generate"><span class="header-section-number">4.2.3</span> Extensions to generate</h3>
<p>The command <code>egen</code><a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> offers some functionality that <code>generate</code> lacks, for example creating the mean of several variables</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">egen</span> &lt;newvar&gt; = <span class="fu">rowmean</span>(var1, var2, var3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The functions which <code>egen</code> support are fairly random; you can see the full list in the help:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">help</span> <span class="kw">egen</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="replacing-existing-variables" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="replacing-existing-variables"><span class="header-section-number">4.3</span> Replacing existing variables</h2>
<p><a href="04-data-manipulation.html#generating-new-variables">Earlier</a> we created the <code>weight2</code> variable which changed the units on weight from pounds to tons. What if, instead of creating a new variable, we tried to just change the existing <code>weight</code> variable.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">generate</span> <span class="kw">weight</span> = <span class="kw">weight</span>/2000</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="kw">variable</span> <span class="kw">weight</span> already defined</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="fu">r</span>(110);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here Stata refuses to proceed since <code>weight</code> is already defined. To overwrite <code>weight</code>, we’ll instead need to use the <code>replace</code> command.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">replace</span> <span class="kw">weight</span> = <span class="kw">weight</span>/2000</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="kw">variable</span> <span class="kw">weight</span> was <span class="kw">int</span> now <span class="kw">float</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>(74 <span class="fu">real</span> changes made)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>. <span class="ot">list</span> <span class="kw">weight</span> <span class="kw">in</span> 1/5</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>     +--------+</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>     | <span class="kw">weight</span> |</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>     |--------|</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  1. |  1.465 |</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  2. |  1.675 |</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  3. |   1.32 |</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  4. |  1.625 |</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  5. |   2.04 |</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>     +--------+</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>replace</code> features syntax identical to <code>generate</code>.<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a></p>
<section id="conditional-variable-generation" class="level3" data-number="4.3.1">
<h3 data-number="4.3.1" class="anchored" data-anchor-id="conditional-variable-generation"><span class="header-section-number">4.3.1</span> Conditional variable generation</h3>
<p>(We’re going to reload the <code>auto</code> data set at this point to ensure all data is as originally saved.)</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">sysuse</span> auto, <span class="kw">clear</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>(1978 automobile <span class="kw">data</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>One frequent task is recoding variables. This can be “binning” continuous variables into a few categories, re-ordering an ordinal variables, or collapsing categories in an already-categorical variable. There are also multi-variable versions; e.g.&nbsp;combining multiple variables into one.</p>
<p>The general workflow with these cases will be to optionally use <code>generate</code> to create the new variable, then use <code>replace</code> to conditional replace the original or new variable.</p>
<p>As an example, let’s generate a new variable which categorizes cars into light, medium weight, and heavy cars. We’ll define light cars as a weight below 1 ton (2000 lbs), and heavy cars as having a weight of 2 tons (4000 lbs) or more.</p>
<p>Before we do this, we’ve learned that the weight reported for the Pont. Grand Prix was incorrect - we don’t know what the correct weight is, but we know the presented one is wrong, so let’s make it missing. We could of course do this manually - open the data editor and delete the value of <code>weight</code> corresponding to the Pont. Grand Prix. As we saw earlier, <a href="02-working-with-data-sets.html#editing-data-manually">manually editing</a> the data like this produces a <code>replace</code> call that we can move into our <a href="01-the-basics-of-stata.html#do-files">Do file for reproducibility</a>. However, this <code>replace</code> call would refer to a row number, something like</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> <span class="kw">weight</span> = . <span class="kw">in</span> 49</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>What would happen if our data was shuffled prior to running this command? It would no longer be applied to the correct row. Therefore, it will be safer to use a <a href="04-data-manipulation.html#restricting-commands-to-subsets">conditional statement</a> to identify the row corresponding to <code>"Pont. Grand Prix"</code>.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">replace</span> <span class="kw">weight</span> = . <span class="kw">if</span> make == <span class="st">"Pont. Grand Prix"</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>(1 <span class="fu">real</span> change made, 1 to <span class="fu">missing</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>. <span class="ot">list</span> make <span class="kw">weight</span> <span class="kw">if</span> make == <span class="st">"Pont. Grand Prix"</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>     +---------------------------+</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>     | make               <span class="kw">weight</span> |</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>     |---------------------------|</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a> 49. | Pont. Grand Prix        . |</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>     +---------------------------+</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now, we’ll return to generating the categorical weight variable. First, we’ll generate the new variable to store this information.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">generate</span> weight_cat = 1</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>. <span class="kw">tab</span> weight_cat</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a> weight_cat |      Freq.     Percent        Cum.</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>          1 |         74      100.00      100.00</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>      Total |         74      100.00</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Without any conditional statements, every observation’s <code>weight_cat</code> is set to 1. We’ll let the 1 represent the “light” category, so next we’ll replace it with 2 for cars in the “medium” category.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">replace</span> weight_cat = 2 <span class="kw">if</span> <span class="kw">weight</span> &gt;= 2000 &amp; <span class="kw">weight</span> &lt; 4000</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>(57 <span class="fu">real</span> changes made)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>. <span class="kw">tab</span> weight_cat</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a> weight_cat |      Freq.     Percent        Cum.</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>          1 |         17       22.97       22.97</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>          2 |         57       77.03      100.00</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>      Total |         74      100.00</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note the choice of <code>&gt;=</code> instead of <code>&gt;</code> and <code>&lt;</code> instead of <code>&lt;=</code>. As above, we stated that light cars have weight <strong>below</strong> 2000 lbs, so medium cars have a value of 2000 <strong>or more</strong> (greater than <strong>or equal</strong>). On the other end, heavy cars have a weght of 4000 lbs <strong>or more</strong>, so medium cars are <strong>strictly</strong> less than 4000 lbs (less than).</p>
<p>Finish with the “heavy” cars</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">replace</span> weight_cat = 3 <span class="kw">if</span> <span class="kw">weight</span> &gt;= 4000</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>(10 <span class="fu">real</span> changes made)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>. <span class="kw">tab</span> weight_cat</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a> weight_cat |      Freq.     Percent        Cum.</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>          1 |          7        9.46        9.46</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>          2 |         57       77.03       86.49</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>          3 |         10       13.51      100.00</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>      Total |         74      100.00</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When using less than/greater than conditinal statements to split a variable into groups, you always want to ensure that when the two “endpoints” are the same, one uses strictly less/more, and the other uses “or equal”. If both use “or equal”, you’ll get inconsistent results for exact values. If neither use “or equal”, exact values will not be classified. (For example, if we had used <code>weight &lt; 4000</code> and <code>weight &gt; 4000</code>, any car with exact weight of 4000 would not fall into either [and its <code>weight_cat</code> would stay 1, a light car]. On the other hand, if we had used <code>weight &lt;= 4000</code> and <code>weight &gt;= 4000</code>, a car with exact weight of 4000 would be assigned to whichever of the lines was run last.)</p>
<p>Lastly, we’ll add some nice labels.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">label</span> <span class="kw">define</span> weight_cat 1 <span class="st">"Light"</span> 2 <span class="st">"Medium"</span> 3 <span class="st">"Heavy"</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>. <span class="kw">label</span> <span class="kw">values</span> weight_cat weight_cat</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>. <span class="kw">tab</span> weight_cat</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a> weight_cat |      Freq.     Percent        Cum.</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>      Light |          7        9.46        9.46</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>     Medium |         57       77.03       86.49</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>      Heavy |         10       13.51      100.00</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>      Total |         74      100.00</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>There’s one additional complication. Stata represents missing values by <code>.</code>, and <code>.</code> has a value of positive infinity. That means that</p>
<p><span class="math display">\[
400 \lt .
\]</span></p>
<p>is true! There is some discussion <a href="http://www.stata.com/support/faqs/data-management/logical-expressions-and-missing-values/">on the Stata FAQs</a> that goes into the rationale behind it, but the short version is that this slightly complicates variable generation but greatly simplifies and protects some data management tasks.</p>
<p>The complication referred to can be seen in the row corresponding to the Pont. Grand Prix</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>. <span class="ot">list</span> make <span class="kw">weight</span> weight_cat <span class="kw">in</span> 46/50</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>     +--------------------------------------+</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>     | make               <span class="kw">weight</span>   <span class="kw">weight</span>~t |</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>     |--------------------------------------|</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a> 46. | Plym. Volare        3,330     Medium |</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a> 47. | Pont. Catalina      3,700     Medium |</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a> 48. | Pont. Firebird      3,470     Medium |</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a> 49. | Pont. Grand Prix        .      Heavy |</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a> 50. | Pont. Le Mans       3,200     Medium |</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>     +--------------------------------------+</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Even though the Grand Prix has no weight, it is categorized as “Heavy”</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">replace</span> weight_cat = . <span class="kw">if</span> <span class="fu">missing</span>(<span class="kw">weight</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>(1 <span class="fu">real</span> change made, 1 to <span class="fu">missing</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>. <span class="kw">tab</span> weight_cat, <span class="fu">missing</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a> weight_cat |      Freq.     Percent        Cum.</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>      Light |          7        9.46        9.46</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>     Medium |         57       77.03       86.49</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>      Heavy |          9       12.16       98.65</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>          . |          1        1.35      100.00</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>      Total |         74      100.00</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>missing()</code> function returns true for each row with a missing value, and false for each row with an observed value, for the variable inside the parantheses (in this case, <code>weight</code>).</p>
<p>You may occasionally see <code>if weight != .</code> or <code>if weight &lt;= .</code> instead of the <code>missing()</code> function. Recall that missing values are sorted to be larger than the largest observed value, so this works just as well as <code>missing()</code>. However, Stata allows you to define “reasons” for missing, specifically <code>.a</code>, <code>.b</code>, all the way through <code>.z</code>. These are sorted such that <code>.</code> &lt; <code>.a</code> &lt; <code>.b</code> &lt; … &lt; <code>.z</code>. For this reason, <code>!= .</code> is not suggested, as while <code>.</code> will be captured as missing, <code>.a</code>, etc will not be. Using <code>missing()</code> removes the temptation to write <code>!=</code> instead of <code>&lt;=</code>.</p>
<p>The <code>missing()</code> function can be proceeded with an exclamation point to indicate not missing. For example</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> x = 2 <span class="kw">if</span> !<span class="fu">missing</span>(<span class="fu">y</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>missing</code> option to <code>tab</code> forces it to show a row for any missing values. Without it, missing rows are suppressed.</p>
<p>To summarize, we used the following commands:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">generate</span> weight_cat = 1</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> weight_cat = 2 <span class="kw">if</span> <span class="kw">weight</span> &gt;= 2000 &amp; <span class="kw">weight</span> &lt; 4000</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> weight_cat = 3 <span class="kw">if</span> <span class="kw">weight</span> &gt;= 4000</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> weight_cat = . <span class="kw">if</span> <span class="fu">missing</span>(<span class="kw">weight</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>There are various other ways it could have been done, such as</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">generate</span> weight_cat = 1 <span class="kw">if</span> <span class="kw">weight</span> &lt; 2000</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> weight_cat = 2 <span class="kw">if</span> <span class="kw">weight</span> &gt;= 2000 &amp; <span class="kw">weight</span> &lt; 4000</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> weight_cat = 3 <span class="kw">if</span> <span class="kw">weight</span> &gt;= 4000 &amp; !<span class="fu">missing</span>(<span class="kw">weight</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb34"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">generate</span> weight_cat = .</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> weight_cat = 1 <span class="kw">if</span> <span class="kw">weight</span> &lt; 2000</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> weight_cat = 2 <span class="kw">if</span> <span class="kw">weight</span> &gt;= 2000 &amp; <span class="kw">weight</span> &lt;= 4000</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> weight_cat = 3 <span class="kw">if</span> <span class="kw">weight</span> &gt; 4000 &amp; !<span class="fu">missing</span>(<span class="kw">weight</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Of course, we could also generate it in the reverse order (3 to 1) or even mixed up (3, 1, 2). There are also alternate ways to write the various conditionals, such as replacing <code>weight &gt; 4000</code> with <code>weight &gt;= 4001</code>. There are usually multiple correct ways to specify any conditional.</p>
</section>
</section>
<section id="more-complicated-replaces" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="more-complicated-replaces"><span class="header-section-number">4.4</span> More complicated replaces</h2>
<p>The above example for <code>replace</code> was fairly simplistic, but you can imagine the need for a much more complicated replacing structure (perhaps based on the value of multiple variables). If, however, you do have something this simple, the <code>recode</code> command could be used instead.</p>
<p>The <code>recode</code> command syntax is fairly simple,</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">recode</span> &lt;oldvar&gt; (&lt;rule 1&gt;) (&lt;rule 2&gt;) ...., <span class="kw">generate</span>(&lt;newvar&gt;)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The different rules define the recoding to take place. For example, the above creation of <code>weight_cat</code> can be written as</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">recode</span> <span class="kw">weight</span> (1/1999 = 1) (2000/4000 = 2) (4001/99999999 = 3) <span class="co">///</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>              (<span class="fu">missing</span> = .), <span class="kw">generate</span>(weight_cat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Each rule has the form of <code>old value(s) = new value</code>, where the old values can be any of:</p>
<ul>
<li>A single number, e.g.&nbsp;<code>(5 = 2)</code>.</li>
<li>several numbers, either
<ul>
<li>a <a href="02-working-with-data-sets.html#loading-subsets-of-the-data">numlist</a> as in this example (note the use of a very large non-missing value for the upper bound)</li>
<li>a space-separated list of values, e.g.&nbsp;<code>(1 5 10 = 4)</code></li>
<li>Mixture of the those two, e.g.&nbsp;<code>(6 10 12/25 31 = 17)</code></li>
</ul></li>
<li>the phrases <code>missing</code>, <code>nonmissing</code> or <code>else</code> to capture anything not elsewhere defined.</li>
</ul>
<p>The new value must be a single number or a missing value (<code>.</code> or <code>.a</code>, etc). <code>else</code> cannot be used if <code>missing</code> or <code>nonmissing</code> is defined (and vice-versa), and all of those must be the last rules defined. E.g.,</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">recode</span> x (<span class="fu">missing</span> = 5) (2 = 4) (<span class="kw">else</span> = 3) (1 = 2), <span class="kw">generate</span>(<span class="fu">y</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>will not run because “missing” and “else” are both simultaneously defined, and because the <code>1 = 2</code> rule is last instead of <code>else</code> or <code>missing</code>.</p>
<p>Note that if you see older code you may see either the parantheses or the <code>generate</code> option excluded. You should include both of these.</p>
<p>Finally, the rules are executed left-to-right. So if you have two rules referring to the same values, the first one is used, and the second is not. For example,</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">recode</span> x (1/5 = 7) (2 = 4), <span class="kw">generate</span>(<span class="fu">y</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>2 = 4</code> rule will never take place because 2 is already recoded to 7 in the <code>1/5 = 7</code> rule.</p>
</section>
<section id="subsetting" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="subsetting"><span class="header-section-number">4.5</span> Subsetting</h2>
<p>Almost any Stata command which operates on variables can operate on a subset of the data instead of the entire data, <a href="04-data-manipulation.html#restricting-commands-to-subsets">as we saw before</a>, by using the <code>if</code> or <code>in</code> statements in the command. This is equivalent to throwing away some data and then performing the command. In general, you should avoid discarding data as you never know when you will possible use it. Of course, you could use <a href="02-working-with-data-sets.html#temporarily-preserving-and-restoring-data"><code>preserve</code> and <code>restore</code></a> to temporarily remove the data, but using the conditional subsetting is more straightforward.</p>
<p>If the conditional logic we want to use involves subsets of the data, we could use this to give us results within each group.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">summarize</span> price</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    Variable |        Obs        Mean    Std. <span class="kw">dev</span>.       Min        Max</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>-------------+---------------------------------------------------------</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>       price |         74    6165.257    2949.496       3291      15906</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>. <span class="kw">summarize</span> price <span class="kw">if</span> foreign == 0</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    Variable |        Obs        Mean    Std. <span class="kw">dev</span>.       Min        Max</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>-------------+---------------------------------------------------------</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>       price |         52    6072.423    3097.104       3291      15906</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>. <span class="kw">summarize</span> price <span class="kw">if</span> foreign == 1</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>    Variable |        Obs        Mean    Std. <span class="kw">dev</span>.       Min        Max</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>-------------+---------------------------------------------------------</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>       price |         22    6384.682    2621.915       3748      12990</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Keep track of the number of observations, <code>Obs</code>, to see that the second and third commands are in fact operating on the subsets. We see here that American cars are cheaper on average<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>.</p>
<section id="repeat-commands-on-subsets" class="level3" data-number="4.5.1">
<h3 data-number="4.5.1" class="anchored" data-anchor-id="repeat-commands-on-subsets"><span class="header-section-number">4.5.1</span> Repeat commands on subsets</h3>
<p>To look at the average price for American and foreign cars, we ran two individual commands. If we wanted to look at the summaries by <code>rep78</code>, that would take 6 commands (values 1 through 5 and <code>.</code>)!</p>
<p>Instead, we can use <code>by</code> and <code>bysort</code> to perform the same operation over each unique value in a variable. For example, we could repeat the above with:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">by</span> foreign: summ price</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>-------------------------------------------------------------------------------</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>-&gt; foreign = Domestic</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    Variable |        Obs        Mean    Std. <span class="kw">dev</span>.       Min        Max</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>-------------+---------------------------------------------------------</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>       price |         52    6072.423    3097.104       3291      15906</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>-------------------------------------------------------------------------------</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>-&gt; foreign = Foreign</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>    Variable |        Obs        Mean    Std. <span class="kw">dev</span>.       Min        Max</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>-------------+---------------------------------------------------------</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>       price |         22    6384.682    2621.915       3748      12990</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>There is a strong assumption here that the data is already sorted by the variables we are splitting <code>by</code> on (e.g.&nbsp;<code>foreign</code>). If <code>foreign</code> were not sorted (or if you simply did not want to check/assume it was), you could instead use</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">bysort</span> foreign: summ price</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>bysort</code> is identical to sorting (which we’ll discuss <a href="04-data-manipulation.html#sorting">later</a>) first and running the <code>by</code> statement afterwards. In general, it is recommended to always use <code>bysort</code> instead of <code>by</code>, <em>unless</em> you believe the data is already sorted and want an error if that assumption is violated.</p>
<p>Before running these commands, consider generating a <a href="04-data-manipulation.html#system-variables">original ordering variable</a> first.</p>
<p><code>bysort</code>’s variables cannot be conditional statements, so if you wanted to for example get summaries by low and high mileage cars, you’d need to generate a dummy variable first.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">gen</span> highmileage = mpg &gt; 20</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>. <span class="kw">bysort</span> highmileage: summ price</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>-------------------------------------------------------------------------------</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>-&gt; highmileage = 0</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    Variable |        Obs        Mean    Std. <span class="kw">dev</span>.       Min        Max</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>-------------+---------------------------------------------------------</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>       price |         38    6937.316    3262.392       3291      14500</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>-------------------------------------------------------------------------------</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>-&gt; highmileage = 1</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>    Variable |        Obs        Mean    Std. <span class="kw">dev</span>.       Min        Max</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>-------------+---------------------------------------------------------</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>       price |         36    5350.306    2358.612       3299      15906</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>bysort</code> can take two or more variables, and performs its commands within each unique combination of the variable. For example,</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">bysort</span> foreign highmileage: summ price</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>-------------------------------------------------------------------------------</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>-&gt; foreign = Domestic, highmileage = 0</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    Variable |        Obs        Mean    Std. <span class="kw">dev</span>.       Min        Max</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>-------------+---------------------------------------------------------</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>       price |         33    6585.606    3149.214       3291      14500</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>-------------------------------------------------------------------------------</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>-&gt; foreign = Domestic, highmileage = 1</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    Variable |        Obs        Mean    Std. <span class="kw">dev</span>.       Min        Max</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>-------------+---------------------------------------------------------</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>       price |         19    5181.105    2867.906       3299      15906</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>-------------------------------------------------------------------------------</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>-&gt; foreign = Foreign, highmileage = 0</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>    Variable |        Obs        Mean    Std. <span class="kw">dev</span>.       Min        Max</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>-------------+---------------------------------------------------------</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>       price |          5      9258.6    3369.459       5719      12990</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>-------------------------------------------------------------------------------</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a>-&gt; foreign = Foreign, highmileage = 1</span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>    Variable |        Obs        Mean    Std. <span class="kw">dev</span>.       Min        Max</span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>-------------+---------------------------------------------------------</span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>       price |         17    5539.412    1686.472       3748       9735</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When specifying <code>bysort</code>, you can optionally specify a variable to sort on but not to group by. For example, let’s say your data consisted of doctors visits for patients, where patients may have more than one appointment. You want to generate a variable indicating whether a visit is the first by the patient. Say <code>id</code> stores the patient id, <code>date</code> stores the date of the visit.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">bysort</span> id (<span class="fu">date</span>): <span class="kw">gen</span> firstvisit = <span class="dt">_n</span> == 1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>By placing <code>date</code> in parentheses, this ensures that within each <code>id</code>, the data is sorted by <code>date</code>. Therefore the first row for each patient is their first visit, so <code>_n == 1</code> evaluates to 1 only in that first row and 0 zero otherwise.</p>
</section>
<section id="discarding-data" class="level3" data-number="4.5.2">
<h3 data-number="4.5.2" class="anchored" data-anchor-id="discarding-data"><span class="header-section-number">4.5.2</span> Discarding data</h3>
<p>If you do want to discard data, you can use <code>keep</code> or <code>drop</code> to do so. They each can perform on variables:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">keep</span> &lt;var1&gt; &lt;var2&gt; ...</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="kw">drop</span> &lt;var1&gt; &lt;var2&gt; ...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>or on observations:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">keep</span> <span class="kw">if</span> &lt;conditional&gt;</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="kw">drop</span> <span class="kw">if</span> &lt;conditional&gt;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that these <em>cannot</em> be combined:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">drop</span> turn <span class="kw">if</span> mpg &gt; 20</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>invalid <span class="kw">syntax</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="fu">r</span>(198);</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>keep</code> removes all variables except the listed variables, or removes any row which the conditional does not return true.</p>
<p><code>drop</code> removes any listed variables, or removes any row which the conditional returns true.</p>
</section>
</section>
<section id="dealing-with-duplicates" class="level2" data-number="4.6">
<h2 data-number="4.6" class="anchored" data-anchor-id="dealing-with-duplicates"><span class="header-section-number">4.6</span> Dealing with duplicates</h2>
<p>If your data is not expected to have duplicates, either across all variables or within certain variables, the <code>duplicates</code> command can make their detection and correction easier. The most basic command is <code>duplicates report</code>, which simply reports on the status of duplicate rows. Let’s use the built-in “bplong” data. This data contains 120 patients (<code>patient</code>) with measures of blood pressure (<code>bp</code>) at two different time points (<code>when</code>, a Before and After), and some descriptive variables (<code>sex</code> and <code>agegrp</code>).</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">sysuse</span> bplong, <span class="kw">clear</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>(Fictional blood-pressure <span class="kw">data</span>)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>. <span class="kw">duplicates</span> <span class="kw">report</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>Duplicates <span class="kw">in</span> terms <span class="kw">of</span> <span class="ot">all</span> variables</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>--------------------------------------</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>   Copies | Observations       Surplus</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>----------+---------------------------</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>        1 |          240             0</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>--------------------------------------</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This report is not very interesting; it reports that there are 240 observations which have 1 copy (e.g.&nbsp;are unique), and hence no surplus. Given that each row should be unique (just in patient ID and before/after alone), this is not surprising. Let’s instead look at the duplicates just for <code>bp</code> and <code>when</code>:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">duplicates</span> <span class="kw">report</span> bp when</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>Duplicates <span class="kw">in</span> terms <span class="kw">of</span> bp when</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>--------------------------------------</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>   Copies | Observations       Surplus</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>----------+---------------------------</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>        1 |           23             0</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>        2 |           42            21</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>        3 |           66            44</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>        4 |           48            36</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>        5 |           35            28</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>        6 |           12            10</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>        7 |           14            12</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>--------------------------------------</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here we have some duplicates. First, there are 23 observations which are fully unique. All other observations have repeats to some extent.</p>
<p>The second row of the output tells of us that there are 42 observations which have 2 copies. The language here can be a bit confusing; all it is saying is that there are 42 rows, each of which has a single duplicate <em>within that same 42</em>. So if we have values 1, 1, 2, 2, that would be reported as 4 observations with 2 surplus.</p>
<p>The number of surplus is the number of non-unique rows in that category. We could compute it ourselves - we know that there are 42 rows with 2 copies, so that means that half of the rows are “unique” and the other half are “duplicates” (which is unique and which is duplicate is not clear). So 42/2 = 21, and we have 21 surplus.</p>
<p>Consider the row for 4 copies. There are 48 rows, each of which belongs to a set of four duplicates. For example, 1, 1, 1, 1, 2, 2, 2, 2, has observations 8 and copies 2. In this row, 48/4 = 12, so there are 12 unique values, meaning 36 surplus.</p>
<p>Other useful commands include</p>
<ul>
<li><code>duplicates list</code>: Shows every set of duplicates, including its row number and value. Obviously for something like this the output would be massive as of the 240 total rows, only 23 are not duplicated to some degree!</li>
<li><code>duplicates tag &lt;vars&gt;, gen(&lt;newvar&gt;)</code>: Adds a new variable which represents the number of other copies for each row. For unique rows, this will be 0. For any duplicated rows, it will essentially be “copies” from <code>duplicates report</code> minus 1. This can be useful for examining duplicates or dropping them.</li>
<li><code>duplicates drop</code>: Be cautious with this, as it drops any row which is a duplicate of a previous row (in other words keeps the first entry of every set of duplicates).</li>
</ul>
</section>
<section id="sorting" class="level2" data-number="4.7">
<h2 data-number="4.7" class="anchored" data-anchor-id="sorting"><span class="header-section-number">4.7</span> Sorting</h2>
<p>We already saw sorting <a href="04-data-manipulation.html#repeat-commands-on-subsets">in the context of <code>bysort</code></a>. We can also sort as a standalone operation. As before, consider generating a <a href="04-data-manipulation.html#system-variables">original ordering variable</a> first.</p>
<p>We’ll switch back to “auto” first.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">sysuse</span> auto, <span class="kw">clear</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>(1978 automobile <span class="kw">data</span>)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>. <span class="kw">gen</span> <span class="kw">order</span> = <span class="dt">_n</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>gsort</code> function takes a list of variables to order by.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">gsort</span> rep78 price</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>. <span class="ot">list</span> rep78 price <span class="kw">in</span> 1/5</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>     +---------------+</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>     | rep78   price |</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>     |---------------|</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>  1. |     1   4,195 |</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>  2. |     1   4,934 |</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>  3. |     2   3,667 |</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>  4. |     2   4,010 |</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>  5. |     2   4,060 |</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>     +---------------+</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Stata first sorts the data by <code>rep78</code>, ascending (so the lowest value is in row 1). Then within each set of rows that have a common value of <code>rep78</code>, it sorts by <code>price</code>.</p>
<p>You can append “+” or “-” to each variable to change whether it is ascending or descending. Without a prefix, the variable is sorted ascending.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">gsort</span> +rep78 -price</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>. <span class="ot">list</span> rep78 price <span class="kw">in</span> 1/5</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>     +----------------+</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>     | rep78    price |</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>     |----------------|</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>  1. |     1    4,934 |</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>  2. |     1    4,195 |</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>  3. |     2   14,500 |</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>  4. |     2    6,342 |</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>  5. |     2    5,886 |</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>     +----------------+</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Recall that missing values (<code>.</code>) are <a href="04-data-manipulation.html#conditional-variable-generation">larger than any other values</a>. When sorting with missing values, they follow this rule as well. If you want to treat missing values as smaller than all other values, you can pass the <code>mfirst</code> option to <code>gsort</code>. Note this does <em>not</em> make missingness “less than” anywhere else, only for the purposes of the current sort.</p>
<p>Sorting strings does work and is done alphabetically. All capital letters are “less than” all lower case letters, and a blank string (<code>""</code>) is the “smallest”. For example, if you have the strings <code>DBC</code>, <code>Daa</code>, <code>""</code><a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>, <code>EEE</code>, the sorted ascending order would be <code>""</code>, <code>DBC</code>, <code>Daa</code>, <code>EEE</code>. The blank is first; the two strings starting with “D” are before the string <code>EEE</code>, and the upper case “B” precedes the lower case “a”.</p>
<p>As a side note, there is an additional command, <code>sort</code>, which can perform sorting. It does not allow sorting in descending order, however it does allow you to sort only a certain number of rows; that is, passing something like <code>sort &lt;varname&gt; in 100/200</code> would sort only rows 100 through 200, leaving the remaining rows remain <em>in their exact same position</em>.</p>
</section>
<section id="working-with-strings-and-categorical-variables" class="level2" data-number="4.8">
<h2 data-number="4.8" class="anchored" data-anchor-id="working-with-strings-and-categorical-variables"><span class="header-section-number">4.8</span> Working with strings and categorical variables</h2>
<p>String variables are commonly used during data collection but are ultimately not very useful from a statistical point of view. Typically string variables should be represented as <a href="03-data-management.html#labeling-values">categorical variables with value labels</a> as we’ve previously discussed. Here are some useful commands for operating on strings and categorical variables.</p>
<section id="converting-between-string-and-numeric" class="level3" data-number="4.8.1">
<h3 data-number="4.8.1" class="anchored" data-anchor-id="converting-between-string-and-numeric"><span class="header-section-number">4.8.1</span> Converting between string and numeric</h3>
<p>These two commands convert strings and numerics between each other.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">destring</span> &lt;<span class="kw">variable</span>&gt;, <span class="kw">gen</span>(&lt;newvar&gt;)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="kw">tostring</span> &lt;<span class="kw">variable</span>&gt;, <span class="kw">replace</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Both commands can take the options <code>replace</code> (to replace the existing variable with the new one) or <code>gen( )</code> (to generate a new variable). I would recommend always using <code>gen</code> to double-check that the conversion worked as expected, then using <code>drop</code>, <code>rename</code> and <code>order</code> to replace the existing variable.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">desc</span> mpg</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>Variable      Storage   Display    Value</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    <span class="bn">name</span>         <span class="dv">type</span>    <span class="kw">format</span>    <span class="kw">label</span>      Variable <span class="kw">label</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>-------------------------------------------------------------------------------</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>mpg             <span class="kw">int</span>     %8.0g                 Mileage (mpg)</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>. <span class="kw">tostring</span> mpg, <span class="kw">gen</span>(mpg2)</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>mpg2 generated <span class="kw">as</span> str2</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>. <span class="kw">desc</span> mpg2</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>Variable      Storage   Display    Value</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>    <span class="bn">name</span>         <span class="dv">type</span>    <span class="kw">format</span>    <span class="kw">label</span>      Variable <span class="kw">label</span></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>-------------------------------------------------------------------------------</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>mpg2            str2    %9s                   Mileage (mpg)</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>. <span class="ot">list</span> mpg* <span class="kw">in</span> 1/5</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>     +------------+</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>     | mpg   mpg2 |</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>     |------------|</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>  1. |  18     18 |</span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>  2. |  24     24 |</span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>  3. |  14     14 |</span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>  4. |  17     17 |</span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>  5. |  16     16 |</span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>     +------------+</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now that the new string is correct, we can replace the existing <code>mpg</code>.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">drop</span> mpg</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>. <span class="kw">rename</span> mpg2 mpg</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>. <span class="kw">order</span> mpg, after(price)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s go the other way around:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">desc</span> mpg</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>Variable      Storage   Display    Value</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    <span class="bn">name</span>         <span class="dv">type</span>    <span class="kw">format</span>    <span class="kw">label</span>      Variable <span class="kw">label</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>-------------------------------------------------------------------------------</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>mpg             str2    %9s                   Mileage (mpg)</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>. <span class="kw">destring</span> mpg, <span class="kw">gen</span>(mpg2)</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>mpg: <span class="ot">all</span> characters <span class="kw">numeric</span>; mpg2 generated <span class="kw">as</span> <span class="kw">byte</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>. <span class="kw">desc</span> mpg2</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>Variable      Storage   Display    Value</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>    <span class="bn">name</span>         <span class="dv">type</span>    <span class="kw">format</span>    <span class="kw">label</span>      Variable <span class="kw">label</span></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>-------------------------------------------------------------------------------</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>mpg2            <span class="kw">byte</span>    %10.0g                Mileage (mpg)</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>. <span class="ot">list</span> mpg* <span class="kw">in</span> 1/5</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>     +------------+</span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>     | mpg   mpg2 |</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>     |------------|</span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>  1. |  18     18 |</span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>  2. |  24     24 |</span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>  3. |  14     14 |</span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>  4. |  17     17 |</span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>  5. |  16     16 |</span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>     +------------+</span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>. <span class="kw">drop</span> mpg</span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a>. <span class="kw">rename</span> mpg2 mpg</span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a>. <span class="kw">order</span> mpg, after(price)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And we’re back to the original set-up.<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a></p>
<p>When using <code>destring</code> to convert a string variable (that it storing numeric data as strings - “13”, “14”) to a numeric variable, if there are <em>any</em> non-numeric entries, <code>destring</code> will fail. For example, lets replace one entry in the <code>make</code> variable with a numeric.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">replace</span> make = <span class="st">"1"</span> <span class="kw">in</span> 1</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>(1 <span class="fu">real</span> change made)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>. <span class="kw">destring</span> make, <span class="kw">gen</span>(make2)</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>make: contains nonnumeric characters; no <span class="kw">generate</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We must pass the <code>force</code> option. With this option, any strings which have non-numeric variables will be marked as missing.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">destring</span> make, <span class="kw">gen</span>(make2) <span class="kw">force</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>make: contains nonnumeric characters; make2 generated <span class="kw">as</span> <span class="kw">byte</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>(73 <span class="fu">missing</span> <span class="kw">values</span> generated)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>. <span class="kw">tab</span> make2, <span class="fu">mi</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>   Make and |</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">model</span> |      Freq.     Percent        Cum.</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>          1 |          1        1.35        1.35</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>          . |         73       98.65      100.00</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>      Total |         74      100.00</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>tostring</code> also accepts the <code>force</code> option when using <code>replace</code>, we recommend instead to <strong>never</strong> use <code>replace</code> with <code>tostring</code> (you probably should not use it with <code>destring</code> either!).</p>
</section>
<section id="converting-strings-into-labeled-numbers" class="level3" data-number="4.8.2">
<h3 data-number="4.8.2" class="anchored" data-anchor-id="converting-strings-into-labeled-numbers"><span class="header-section-number">4.8.2</span> Converting strings into labeled numbers</h3>
<p>If we have a string variable which has non-numerical values (e.g.&nbsp;<code>race</code> with values “white”, “black”, “Hispanic”, etc), the ideal way to store it is as numerical with <a href="03-data-management.html#labeling-values">value labels</a> attached. While we could do this manually using a combination of <code>gen</code> and <code>replace</code> with some conditionals, a less tedious way to do so is via <code>encode</code>.</p>
<p>We’ll switch to the “hbp2” data set from the Stata website, records some blood pressure measurements. Remember this will erase any existing unsaved changes! You will not need any modifications you’ve made to other built-in datasets going forward (except <code>census9</code> from <a href="03-data-management.html#exercise-3">Exercise 3</a> which you should already have saved), but if you do want to save it, do so first!</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">webuse</span> hbp2, <span class="kw">clear</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>. <span class="kw">tab</span> sex, <span class="fu">missing</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>        Sex |      Freq.     Percent        Cum.</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>            |          2        0.18        0.18</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>     female |        433       38.32       38.50</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>       male |        695       61.50      100.00</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>      Total |      1,130      100.00</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>. <span class="kw">desc</span> sex</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>Variable      Storage   Display    Value</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>    <span class="bn">name</span>         <span class="dv">type</span>    <span class="kw">format</span>    <span class="kw">label</span>      Variable <span class="kw">label</span></span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>-------------------------------------------------------------------------------</span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>sex             str6    %9s                   Sex</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>sex</code> variable is a string with two values. First, let’s create a numeric with value labels version manually.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">gen</span> male = sex == <span class="st">"male"</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>. <span class="kw">label</span> <span class="kw">define</span> male 0 <span class="st">"female"</span> 1 <span class="st">"male"</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>. <span class="kw">label</span> <span class="kw">values</span> male male</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>. <span class="kw">tab</span> male, <span class="fu">missing</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>       male |      Freq.     Percent        Cum.</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>     female |        435       38.50       38.50</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>       male |        695       61.50      100.00</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>      Total |      1,130      100.00</span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>. <span class="kw">replace</span> male = . <span class="kw">if</span> sex == <span class="st">""</span></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>(2 <span class="fu">real</span> changes made, 2 to <span class="fu">missing</span>)</span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>. <span class="kw">tab</span> male, <span class="fu">missing</span></span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a>       male |      Freq.     Percent        Cum.</span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>     female |        433       38.32       38.32</span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a>       male |        695       61.50       99.82</span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a>          . |          2        0.18      100.00</span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a>      Total |      1,130      100.00</span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a>. <span class="kw">tab</span> male, <span class="fu">missing</span> <span class="kw">nolabel</span></span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-31"><a href="#cb60-31" aria-hidden="true" tabindex="-1"></a>       male |      Freq.     Percent        Cum.</span>
<span id="cb60-32"><a href="#cb60-32" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb60-33"><a href="#cb60-33" aria-hidden="true" tabindex="-1"></a>          0 |        433       38.32       38.32</span>
<span id="cb60-34"><a href="#cb60-34" aria-hidden="true" tabindex="-1"></a>          1 |        695       61.50       99.82</span>
<span id="cb60-35"><a href="#cb60-35" aria-hidden="true" tabindex="-1"></a>          . |          2        0.18      100.00</span>
<span id="cb60-36"><a href="#cb60-36" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb60-37"><a href="#cb60-37" aria-hidden="true" tabindex="-1"></a>      Total |      1,130      100.00</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Instead, we can easily use <code>encode</code>:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">encode</span> sex, <span class="kw">gen</span>(sex2)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>. <span class="kw">tab</span> sex2, <span class="fu">missing</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>        Sex |      Freq.     Percent        Cum.</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>     female |        433       38.32       38.32</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>       male |        695       61.50       99.82</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>          . |          2        0.18      100.00</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>      Total |      1,130      100.00</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>. <span class="kw">tab</span> sex2, <span class="fu">missing</span> <span class="kw">nolabel</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>        Sex |      Freq.     Percent        Cum.</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>          1 |        433       38.32       38.32</span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>          2 |        695       61.50       99.82</span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>          . |          2        0.18      100.00</span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>      Total |      1,130      100.00</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>However, we see that <code>encode</code> starts numbering at 1 instead of 0, which is not ideal for dummy variables. To get around this, we can create our value label manually first, then pass it as an argument to <code>encode</code>.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">label</span> <span class="kw">define</span> manualsex 0 <span class="st">"female"</span> 1 <span class="st">"male"</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>. <span class="kw">encode</span> sex, <span class="kw">gen</span>(sex3) <span class="kw">label</span>(manualsex)</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>. <span class="kw">tab</span> sex3, <span class="fu">missing</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>        Sex |      Freq.     Percent        Cum.</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>     female |        433       38.32       38.32</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>       male |        695       61.50       99.82</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>          . |          2        0.18      100.00</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>      Total |      1,130      100.00</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>. <span class="kw">tab</span> sex3, <span class="fu">missing</span> <span class="kw">nolabel</span></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>        Sex |      Freq.     Percent        Cum.</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>          0 |        433       38.32       38.32</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>          1 |        695       61.50       99.82</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>          . |          2        0.18      100.00</span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a>      Total |      1,130      100.00</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This can be extended to allow any sort of ordering desired. For this trivial binary example, it might actually be faster to use <code>gen</code> and do it manually, but for a variable with a large number of categories, this is much easier.</p>
<p><code>decode</code> works in the reverse, creating a string out of a numeric vector with labels attached to it.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">decode</span> sex3, <span class="kw">gen</span>(sex4)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>. <span class="kw">desc</span> sex4</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>Variable      Storage   Display    Value</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    <span class="bn">name</span>         <span class="dv">type</span>    <span class="kw">format</span>    <span class="kw">label</span>      Variable <span class="kw">label</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>-------------------------------------------------------------------------------</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>sex4            str6    %9s                   Sex</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>. <span class="kw">tab</span> sex4, <span class="fu">missing</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>        Sex |      Freq.     Percent        Cum.</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>            |          2        0.18        0.18</span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>     female |        433       38.32       38.50</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>       male |        695       61.50      100.00</span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>------------+-----------------------------------</span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>      Total |      1,130      100.00</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>decode</code> will fail if its target does not have value labels attached.</p>
</section>
<section id="string-manipulation" class="level3" data-number="4.8.3">
<h3 data-number="4.8.3" class="anchored" data-anchor-id="string-manipulation"><span class="header-section-number">4.8.3</span> String manipulation</h3>
<p>If you find yourself in a situation where you simply must manipulate the strings directly, there are a number of string functions. You can see the full list in <code>help string functions</code>, but below we list a few commonly used ones.</p>
<ul>
<li><code>strlen</code>: Returns the number of characters in the string</li>
<li><code>wordcount</code>: Returns the number of whitespace-separated words.</li>
<li><code>+</code>: Adding two strings together concatenates them (e.g.&nbsp;<code>abc + def</code> = <code>abcdef</code>).</li>
<li><code>strupper</code> and <code>strlower</code>: Converts to lower/upper case.</li>
<li><code>strtrim</code>: Removes white space preceding and following non-string characters in a string (e.g.&nbsp;<code>strtrim("  string   ") = "string"</code>). To remove only left (preceding) or right (following) spaces, use <code>strltrim</code> or <code>strrtrim</code>.</li>
<li><code>substr</code>: Returns the substring starting at an index for a given number of characters (e.g.&nbsp;<code>substr("abcdefg", 2, 3) = "bcd"</code>).</li>
</ul>
<p>These can be used inside <code>gen</code> and <code>replace</code>, e.g.</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">gen</span> sexupper = <span class="fu">strupper</span>(sex)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>(2 <span class="fu">missing</span> <span class="kw">values</span> generated)</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>. <span class="kw">gen</span> sexinitial = <span class="fu">substr</span>(sexupper, 1, 1)</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>(2 <span class="fu">missing</span> <span class="kw">values</span> generated)</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>. <span class="ot">list</span> sex sexupper sexinitial <span class="kw">in</span> 1/5</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>     +------------------------------+</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>     |    sex   sexupper   sexini~<span class="ot">l</span> |</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>     |------------------------------|</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>  1. | female     FEMALE          <span class="fu">F</span> |</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>  2. |                              |</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>  3. |   male       MALE          M |</span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>  4. |   male       MALE          M |</span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>  5. | female     FEMALE          <span class="fu">F</span> |</span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>     +------------------------------+</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="exercise-5" class="level2" data-number="4.9">
<h2 data-number="4.9" class="anchored" data-anchor-id="exercise-5"><span class="header-section-number">4.9</span> Exercise 5</h2>
<p>Open the <em>saved</em> version of “census9” with <code>use</code>, not the original version with <code>webuse</code>.</p>
<ol type="1">
<li>Generate a new variable, <code>deathperc</code>, which is the percentage of deaths in each state. (Remember that <code>deathrate</code> is deaths per 10,000.)</li>
<li>The average age of all Americans in 1980 is roughly 30.11 years of age. <a href="04-data-manipulation.html#conditional-variable-generation">Generate a categorical</a> with four values as described before, with appropriate <a href="03-data-management.html#labeling-values">value labels</a>.
<ul>
<li>Significantly below national average: <code>medage</code> equal to 26.20 or less</li>
<li>Below national average: <code>medage</code> greater than 26.20 and less than or equal to 30.10.</li>
<li>Above national average: <code>medage</code> greater than 30.10 and less than or equal to 32.80.</li>
<li>Significantly above national average: <code>medage</code> greater than 32.80.</li>
</ul></li>
<li>What is the death rate in <a href="04-data-manipulation.html#repeat-commands-on-subsets">each of those four categories</a>? (You can use <code>summarize</code> to obtain the means.) Does there appear to be any pattern?</li>
<li>What state has the <a href="04-data-manipulation.html#sorting">lowest</a> death rate? The highest? The lowest average age? The highest?</li>
<li>Each state has a single observation here, but if we had multiple years of data, then we could have <a href="04-data-manipulation.html#reshaping-files">“long data”</a> with multiple rows per state. To prepare for this sort of data, <a href="04-data-manipulation.html#converting-strings-into-labeled-numbers">encode</a> the two-letter state abbreviation into a numeric value with value labels.</li>
</ol>
</section>
<section id="merging-files" class="level2" data-number="4.10">
<h2 data-number="4.10" class="anchored" data-anchor-id="merging-files"><span class="header-section-number">4.10</span> Merging Files</h2>
<p>When managing data sets, the need often arises to merge two data sets together, either by matching two files together according to values on certain variables, or by adding cases to an existing data set. We’ll start with the simpler case of adding cases to an existing data set.</p>
<section id="appending-files" class="level3" data-number="4.10.1">
<h3 data-number="4.10.1" class="anchored" data-anchor-id="appending-files"><span class="header-section-number">4.10.1</span> Appending Files</h3>
<p>Appending is straightforward. Observations in a new data set (called the “using” data) are appended to the current data set (called the “master” data), matching variable names. If a variable in the using data exists already in the master data, its values are entered there. If a variable in the using data does not exist in the master, the new variable is added to the appended data set which is missing for all members of the master data. This is easiest to visualize. There are two data sets on <a href="02-working-with-data-sets.html#stata-website-data">Stata’s website</a> which we can append, “odd” and “even”.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">webuse</span> odd, <span class="kw">clear</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>(First five odd numbers)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>. <span class="ot">list</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>     +--------------+</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>     | number   odd |</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>     |--------------|</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>  1. |      1     1 |</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>  2. |      2     3 |</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>  3. |      3     5 |</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>  4. |      4     7 |</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>  5. |      5     9 |</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>     +--------------+</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>. <span class="kw">webuse</span> even</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>(6th through 8th even numbers)</span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>. <span class="ot">list</span></span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>     +---------------+</span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>     | number   even |</span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>     |---------------|</span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>  1. |      6     12 |</span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>  2. |      7     14 |</span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a>  3. |      8     16 |</span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a>     +---------------+</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It does not truly matter which data set is the master data and which is the using data (it will later in <a href="04-data-manipulation.html#match-merging-data">match-merging</a>), it will only affect the sorted order (the data in master is sorted first). The syntax is simply</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="kw">append</span> <span class="kw">using</span> &lt;<span class="kw">using</span> <span class="kw">data</span>&gt;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb67"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">webuse</span> even</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>(6th through 8th even numbers)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>. <span class="kw">append</span> <span class="kw">using</span> http:<span class="co">//www.stata-press.com/data/r16/odd</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">variable</span> number was <span class="kw">byte</span>, now <span class="kw">float</span> to accommodate <span class="kw">using</span> data's <span class="kw">values</span>)</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>. <span class="ot">list</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>     +---------------------+</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>     | number   even   odd |</span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>     |---------------------|</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>  1. |      6     12     . |</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>  2. |      7     14     . |</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>  3. |      8     16     . |</span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>  4. |      1      .     1 |</span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>  5. |      2      .     3 |</span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>     |---------------------|</span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>  6. |      3      .     5 |</span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>  7. |      4      .     7 |</span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>  8. |      5      .     9 |</span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a>     +---------------------+</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(We must specify the complete path to the data instead of the <code>webuse</code> shorthand of just the data name. Of course, with real data that you locally have on your computer, you follow the <a href="01-the-basics-of-stata.html#working-directory">working directory</a> rules; if the file exists in your working directory you just give the name, otherwise give the complete path. I obtained that path by visiting the Stata data website and finding the link to “odd”.)</p>
<p>Note that the “number” variable, which exists in both data sets, has complete data, while “even” and “odd” both have missing data as expected. The <code>using</code> part of the command is where the term the “using data” comes from.</p>
<p>Stata is case sensitive in its variable names, so “varname” and “Varname” are two unique variables. We could always fix this later with something like</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="kw">replace</span> varname = Varname <span class="kw">if</span> varname == .</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>but it is better to ensure before appending that the shared variables have identical names.</p>
</section>
<section id="match-merging-data" class="level3" data-number="4.10.2">
<h3 data-number="4.10.2" class="anchored" data-anchor-id="match-merging-data"><span class="header-section-number">4.10.2</span> Match-merging Data</h3>
<p>A more common data management necessity is to add variables from another data set to a master data set, match-merging the cases in the data sets by values on a single ID variable (or by values on multiple variables). There are two general forms of this match-merging.</p>
<p>The first, one-to-one merging, occurs when in each data, each individual is represented by only one row. For example, one data set containing final exam information and one data set containing demographic information. This “1:1” match takes rows which match on some variable(s) and places them together.</p>
<p>The second match, many-to-one, occurs when the data are measured on different “levels”. For example, consider if we have one data set containing household level characteristics and another containing town level characters. Two households from the same town would want the same town level data. This is either “1:m” or “m:1” depending on which data is the master data and which is the using data (e.g.&nbsp;1:m indicates the household data is the master data and town is the using data).</p>
<p>(Technically there is also many-to-many matching, “m:m”, but it is rarely used in practice.)</p>
<p>We’ll use data sets off Stata’s website again to demonstrate, specifically the “autosize” and “autocost” data which splits the “auto” data into two pieces.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">webuse</span> autosize, <span class="kw">clear</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>(1978 automobile <span class="kw">data</span>)</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>. <span class="ot">list</span> <span class="kw">in</span> 1/5</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>     +------------------------------------+</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>     | make               <span class="kw">weight</span>   <span class="fu">length</span> |</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>     |------------------------------------|</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>  1. | Toyota Celica       2,410      174 |</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>  2. | BMW 320i            2,650      177 |</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>  3. | Cad. Seville        4,290      204 |</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>  4. | Pont. Grand Prix    3,210      201 |</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>  5. | Datsun 210          2,020      165 |</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>     +------------------------------------+</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>. <span class="kw">webuse</span> autocost</span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>(1978 automobile <span class="kw">data</span>)</span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>. <span class="ot">list</span> <span class="kw">in</span> 1/5</span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a>     +-----------------------------+</span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>     |        make   price   rep78 |</span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>     |-----------------------------|</span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>  1. | AMC Concord    4099       3 |</span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>  2. |   AMC Pacer    4749       3 |</span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a>  3. |  AMC Spirit    3799       . |</span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a>  4. |   Audi 5000    9690       5 |</span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a>  5. |    Audi Fox    6295       3 |</span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a>     +-----------------------------+</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now we can perform the merge using the syntax.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="kw">merge</span> 1:1 &lt;variables to <span class="fu">match</span> <span class="kw">on</span>&gt; <span class="kw">using</span> &lt;<span class="kw">using</span> <span class="kw">data</span> <span class="kw">set</span>&gt;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>All that needs to be specified is the variable to match cases by and the name of the data set with variables to be added. We could replace <code>1:1</code> with <code>m:1</code> or <code>1:m</code> as desired.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">merge</span> 1:1 make <span class="kw">using</span> http:<span class="co">//www.stata-press.com/data/r16/autosize</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    Result                      Number <span class="kw">of</span> <span class="kw">obs</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>    -----------------------------------------</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>    Not matched                            68</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>        from master                        68  (<span class="dt">_merge</span>==1)</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>        from <span class="kw">using</span>                          0  (<span class="dt">_merge</span>==2)</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>    Matched                                 6  (<span class="dt">_merge</span>==3)</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>    -----------------------------------------</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>. <span class="ot">list</span> <span class="kw">in</span> 3/6</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>     +----------------------------------------------------------------+</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>     |       make   price   rep78   <span class="kw">weight</span>   <span class="fu">length</span>            <span class="dt">_merge</span> |</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>     |----------------------------------------------------------------|</span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>  3. | AMC Spirit    3799       .        .        .   Master only (1) |</span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>  4. |  Audi 5000    9690       5        .        .   Master only (1) |</span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a>  5. |   Audi Fox    6295       3        .        .   Master only (1) |</span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a>  6. |   BMW 320i    9735       4    2,650      177       Matched (3) |</span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a>     +----------------------------------------------------------------+</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>(Again, we use the full path but for local files, following <a href="01-the-basics-of-stata.html#working-directory">working directory</a> rules.)</p>
<p>First, take a look at the output of the merge command. We see that 68 cars were not matched, which means they exist in only one of the two data sets. In this case, they all exist in master data, but in general you could see a mix of the two. The remaining 6 observations were appropriately matched. This is a terrible merge! Hopefully with your real data, the majority of data is matched and only a few outliers are not matched.</p>
<p>Notice the <code>(_merge==#)</code> tags. When you perform a merge, a new variable <code>_merge</code> is added which indicates the source for each row: 1 and 2 indicate the data was only found in the master data or using data respectively, while 3 indicates a match. There are two other possible values (4 and 5) which occur rarely, see the documentation at <code>help merge</code> for details.</p>
<p>A few notes:</p>
<ul>
<li>Stata will sort both files by the key variables before and after merging.</li>
<li>You can match on more than one variable. For example, if you had data based upon year and state, you might run <code>merge 1:1 state year using ...</code></li>
<li>If you wanted to merge another file after the initial merge, you’ll need to drop the <code>_merge</code> variable first.</li>
<li>IMPORTANT NOTE: Make sure that the only variables common to both files when performing a match-merge are the variables that will be used to match cases (like ID)! Stata will by default keep the variable in the master data when the merge is performed if the same variable appears in more than one file and is not defined as a matching variable. This may cause problems when performing merges. (You can overwrite this behavior with the <code>update</code> or <code>replace</code> options, see the documentation for details.)</li>
</ul>
</section>
</section>
<section id="reshaping-files" class="level2" data-number="4.11">
<h2 data-number="4.11" class="anchored" data-anchor-id="reshaping-files"><span class="header-section-number">4.11</span> Reshaping Files</h2>
<p>Different data formats are needed for various statistical methods. Stata prefers data in “Long” format, but also makes it easy to convert between Long and “Wide”. Stata uses the <code>reshape</code> command to convert data formats.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./images/wide-vs-long.png"><img src="./images/wide-vs-long.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
<p>In this example, the wide format of the data has each row representing a single observation. The variables <code>X1</code>, <code>X2</code> and <code>X3</code> are what make this “wide”. These are typically variables measured at different time points, but don’t have to be. In the long format, each row represents an observation <em>at a specific index</em>.</p>
<p>A nice feature of Stata’s <code>reshape</code> command is that the syntax to convert from wide-to-long or from long-to-wide are identical, except for desired format (<code>long</code> vs <code>wide</code>).</p>
<p>Convert to long:</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="kw">reshape</span> <span class="kw">long</span> &lt;stub&gt;, i(&lt;ivar&gt;) j(&lt;jvar&gt;)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Convert to wide:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="kw">reshape</span> <span class="kw">wide</span> &lt;stub&gt;, i(&lt;ivar&gt;) j(&lt;jvar&gt;)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We need to identify three components, the <code>stub</code>, <code>ivar</code> and <code>jvar</code>.</p>
<ul>
<li>“stub”: The stub in wide format is the common prefix of the repeated variables names. In the illustration above, <code>X1</code>, <code>X2</code> and <code>X3</code> have the common prefix “X”. In the long format, the stub is simply the name of the variable which is repeated. In the illustration above, <code>X</code> is this variable. Hence the stub is <code>X</code> for both.</li>
<li>“ivar”: The ivar is the id variable. In the long format, this should be constant across individuals. In both formats above, the id is <code>ID</code>.</li>
<li>“jvar”: The jvar in long format is the variable that distinguishes which index each repeated measure is from. In the illustration above, <code>Index</code> fills this role. In wide format, this does not exist. So when converting from wide to long, you can use any name for the jvar.</li>
</ul>
<p>Putting this all together together, the two commands to convert between the illustrations above would be:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="kw">reshape</span> <span class="kw">long</span> X, i(ID) j(Index)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="kw">reshape</span> <span class="kw">wide</span> X, i(ID) j(Index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As an example, we’ll use the built-in data set “bplong”</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">sysuse</span> bplong, <span class="kw">clear</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>(Fictional blood-pressure <span class="kw">data</span>)</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>. <span class="ot">list</span> <span class="kw">in</span> 1/5</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>     +----------------------------------------+</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>     | patient    sex   agegrp     when    bp |</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>     |----------------------------------------|</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>  1. |       1   Male    30-45   Before   143 |</span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>  2. |       1   Male    30-45    After   153 |</span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>  3. |       2   Male    30-45   Before   163 |</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>  4. |       2   Male    30-45    After   170 |</span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>  5. |       3   Male    30-45   Before   153 |</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>     +----------------------------------------+</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Each patient has two rows representing their before and after measurements. <code>when</code> indicates which time period the measurement occurs in, and <code>bp</code> is the only time-varying variable (both <code>sex</code> and <code>agegrp</code> are constant, presumably the “Before” and “After” occur within a short time period such that neither of those can change). Let’s identify the three components</p>
<ul>
<li>“stub”: Since we’re going from long to wide, the “stub” is any time-varying variables, here only <code>bp</code>.</li>
<li>“ivar”: <code>patient</code> identifies individuals.</li>
<li>“jvar”: <code>when</code> identifies time period.</li>
</ul>
<p>Putting this together,</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">reshape</span> <span class="kw">wide</span> bp, i(patient) j(when)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>(j = 1 2)</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>Data                               Long   -&gt;   Wide</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>-----------------------------------------------------------------------------</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>Number <span class="kw">of</span> observations              240   -&gt;   120         </span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>Number <span class="kw">of</span> variables                   5   -&gt;   5           </span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>j <span class="kw">variable</span> (2 <span class="kw">values</span>)              when   -&gt;   (dropped)</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>xij variables:</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>                                     bp   -&gt;   bp1 bp2</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>-----------------------------------------------------------------------------</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>. <span class="ot">list</span> <span class="kw">in</span> 1/5</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>     +-------------------------------------+</span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>     | patient   bp1   bp2    sex   agegrp |</span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>     |-------------------------------------|</span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>  1. |       1   143   153   Male    30-45 |</span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>  2. |       2   163   170   Male    30-45 |</span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a>  3. |       3   153   168   Male    30-45 |</span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a>  4. |       4   153   142   Male    30-45 |</span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a>  5. |       5   146   141   Male    30-45 |</span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a>     +-------------------------------------+</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Each row represents a single patient, and <code>bp1</code> and <code>bp2</code> represent the before and after measurements.</p>
<p>Let’s generate the command to convert back to long.</p>
<ul>
<li>“stub”: “bp” is the stub of <code>bp1</code> and <code>bp2</code>.</li>
<li>“ivar”: <code>patient</code> identifies individuals.</li>
<li>“jvar”: Since the data is currently wide, there is no existing jvar and we can call it whatever we like. For consistency, we’ll call it “when” again.</li>
</ul>
<p>The command is identical! Just swap <code>wide</code> for <code>long</code>.</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">reshape</span> <span class="kw">long</span> bp, i(patient) j(when)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>(j = 1 2)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>Data                               Wide   -&gt;   Long</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>-----------------------------------------------------------------------------</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>Number <span class="kw">of</span> observations              120   -&gt;   240         </span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>Number <span class="kw">of</span> variables                   5   -&gt;   5           </span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>j <span class="kw">variable</span> (2 <span class="kw">values</span>)                     -&gt;   when</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>xij variables:</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>                                bp1 bp2   -&gt;   bp</span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>-----------------------------------------------------------------------------</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>. <span class="ot">list</span> <span class="kw">in</span> 1/5</span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>     +----------------------------------------+</span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>     | patient     when    bp    sex   agegrp |</span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>     |----------------------------------------|</span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>  1. |       1   Before   143   Male    30-45 |</span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>  2. |       1    After   153   Male    30-45 |</span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a>  3. |       2   Before   163   Male    30-45 |</span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>  4. |       2    After   170   Male    30-45 |</span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a>  5. |       3   Before   153   Male    30-45 |</span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a>     +----------------------------------------+</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The variables are slightly out of order, but we’ve completely recovered the original data.</p>
<p>After you’ve run a single <code>reshape</code> command, and assuming nothing has changed (you do not want to change <code>stub</code>, <code>ivar</code> or <code>jvar</code>, and the variables in the data are the same), you can convert between wide and long without specifying anything. Try it:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="kw">reshape</span> <span class="kw">wide</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="kw">reshape</span> <span class="kw">long</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now, notice that when we reshaped the original long data into wide format, the two “bp” variables where <code>bp1</code> and <code>bp2</code>, not something like <code>bp_before</code> and <code>bp_after</code>. In most cases this is fine (as the common use case for this is repeated measures over time), but not always - what if we wanted to save the “before” and “after” labels? Do note that thankfully Stata saves these labels, so when converting back to long, it restores the “Before” and “After” tags.</p>
<p>If you do want to save the text instead of the count, you need to use strings. We’ll use <a href="04-data-manipulation.html#converting-strings-into-labeled-numbers"><code>decode</code></a> to convert to a string, then use that as the jvar.</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">decode</span> when, <span class="kw">gen</span>(when2)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>. <span class="kw">drop</span> when</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>. <span class="kw">rename</span> when2 when</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>. <span class="kw">reshape</span> <span class="kw">wide</span> bp, i(patient) j(when) <span class="fu">string</span></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>(j = After Before)</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>Data                               Long   -&gt;   Wide</span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>-----------------------------------------------------------------------------</span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>Number <span class="kw">of</span> observations              240   -&gt;   120         </span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>Number <span class="kw">of</span> variables                   5   -&gt;   5           </span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>j <span class="kw">variable</span> (2 <span class="kw">values</span>)              when   -&gt;   (dropped)</span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>xij variables:</span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>                                     bp   -&gt;   bpAfter bpBefore</span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>-----------------------------------------------------------------------------</span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a>. <span class="ot">list</span> <span class="kw">in</span> 1/5</span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a>     +----------------------------------------------+</span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a>     | patient   bpAfter   bpBefore    sex   agegrp |</span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a>     |----------------------------------------------|</span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true" tabindex="-1"></a>  1. |       1       153        143   Male    30-45 |</span>
<span id="cb79-25"><a href="#cb79-25" aria-hidden="true" tabindex="-1"></a>  2. |       2       170        163   Male    30-45 |</span>
<span id="cb79-26"><a href="#cb79-26" aria-hidden="true" tabindex="-1"></a>  3. |       3       168        153   Male    30-45 |</span>
<span id="cb79-27"><a href="#cb79-27" aria-hidden="true" tabindex="-1"></a>  4. |       4       142        153   Male    30-45 |</span>
<span id="cb79-28"><a href="#cb79-28" aria-hidden="true" tabindex="-1"></a>  5. |       5       141        146   Male    30-45 |</span>
<span id="cb79-29"><a href="#cb79-29" aria-hidden="true" tabindex="-1"></a>     +----------------------------------------------+</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note the <code>string</code> option. When converting back to long, you’ll need to <code>encode</code> the string to get it back to numeric.</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode stata code-with-copy"><code class="sourceCode stata"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>. <span class="kw">reshape</span> <span class="kw">long</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>(j = After Before)</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>Data                               Wide   -&gt;   Long</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>-----------------------------------------------------------------------------</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>Number <span class="kw">of</span> observations              120   -&gt;   240         </span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>Number <span class="kw">of</span> variables                   5   -&gt;   5           </span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>j <span class="kw">variable</span> (2 <span class="kw">values</span>)                     -&gt;   when</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>xij variables:</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>                       bpAfter bpBefore   -&gt;   bp</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>-----------------------------------------------------------------------------</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>. <span class="kw">desc</span> when</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>Variable      Storage   Display    Value</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>    <span class="bn">name</span>         <span class="dv">type</span>    <span class="kw">format</span>    <span class="kw">label</span>      Variable <span class="kw">label</span></span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>-------------------------------------------------------------------------------</span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>when            str6    %9s                   Status</span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>. <span class="kw">encode</span> when, <span class="kw">gen</span>(when2)</span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a>. <span class="kw">drop</span> when</span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a>. <span class="kw">rename</span> when2 when</span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a>. <span class="kw">desc</span> when</span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a>Variable      Storage   Display    Value</span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a>    <span class="bn">name</span>         <span class="dv">type</span>    <span class="kw">format</span>    <span class="kw">label</span>      Variable <span class="kw">label</span></span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a>-------------------------------------------------------------------------------</span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a>when            <span class="kw">long</span>    %8.0g      when2      Status</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A few notes:</p>
<ul>
<li><p>If you have wide data and some individuals are missing some repeated measures, when converting to tall, they will still have a row with a blank value. You can easily drop it:</p>
<pre><code>reshape long
drop if &lt;varname&gt; == .</code></pre>
<p>Converting back to wide will re-enter those missing values; <code>reshape</code> does not care if the long data is “complete”.</p></li>
<li><p>More than one stub can be entered if you have more than one repeated measurement. For example, if the variables were {“id”, “x1”, “x2”, “y1”, “y2”}, you could enter</p>
<pre><code>reshape long x y, i(id) j(index)</code></pre>
<p>Note that they technically don’t have to have the same indices (e.g.&nbsp;you could have “x1”, “x2”, “y3”, “y4”) although that would create a weird result where each row of index 1 or 2 is missing <code>y</code> and each row of index 3 or 4 is missing <code>x</code>.</p></li>
<li><p>If you have wide data and many time-varying variables, there is no shorthand for entering all the stubs. For large data, this is <strong>extremely</strong> frustrating. I’d recommend using <code>describe, simple</code> to get a list of all variable names, then using find &amp; replace to remove the indices. If you know a better way, <a href="index.html#contact-information">let me know</a>!</p></li>
</ul>


</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p>If you want log with a different base, you can use the transformation that dividing by <code>log(b)</code> is equivalent to using <code>b</code> as a base. In other words, if you need log base 10, use <code>gen newvar = log(oldvar)/log(10)</code>.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>Technically and mathematically they can take on any two values, but your life will be easier if you stick with the 0/1 convention.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>This is true of most statistical software in fact.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>We’ll see some exceptions to this in the <a href="05-programming.html">programming</a> section.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p><code>egen</code> is <strong>not</strong> a <a href="01-the-basics-of-stata.html#short-commands">short command</a> for “egenerate”; the full command name is simply “<code>egen</code>”.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p><code>generate</code> has a few features we do not discuss which <code>replace</code> does not support. Namely, <code>generate</code> can set the <a href="03-data-management.html#describing-the-data">type</a> manually (instead of letting Stata choose the best type <a href="03-data-management.html#compressing-data">automatically</a>), and <code>generate</code> can place the new variable as desired rather than <a href="03-data-management.html#changing-variable-ordering">using <code>order</code></a>. Clearly, neither of these features are needed for <code>replace</code>.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>Note that this is not a statistical claim, we would have to do a two-sample t-test to make any statistical claim.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p>I’m explcitly writing the quotations here as otherwise it would just look missing. The quotations aren’t part of the saved string.<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9"><p>If you are sharp-eyed, you may have noticed that the original <code>mpg</code> was an “int” whereas the final one is a “byte”. If we had called <a href="03-data-management.html#compressing-data"><code>compress</code></a> on the original data, it would have done that type conversion anyways - so we’re ok!<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./03-data-management.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Data Management</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./05-programming.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Programming &amp; Advanced Features</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>